海思 Hi3798MV100 定制 Ubuntu 系统构建指南
一、准备工作
1. 获取基础文件
# 下载 TTL 刷机包（从指定链接获取对应型号）
# 解压后得到 rootfs-32.img 文件

# 下载 Ubuntu 基础系统
wget https://cdimage.ubuntu.com/ubuntu-base/releases/20.04/release/ubuntu-base-20.04.5-base-armhf.tar.gz
# 安装必要工具
sudo apt update
sudo apt install qemu-user-static rsync -y

# 创建并解压 Ubuntu 根文件系统
mkdir ubuntu-rootfs
sudo tar -xpf ubuntu-base-20.04.5-base-armhf.tar.gz -C ubuntu-rootfs/
# 准备 qemu 模拟器
sudo cp /usr/bin/qemu-arm-static ubuntu-rootfs/usr/bin/

# 配置 DNS
sudo cp /etc/resolv.conf ubuntu-rootfs/etc/resolv.conf

# 挂载必要的系统目录
sudo mount -t proc /proc ubuntu-rootfs/proc
sudo mount -t sysfs /sys ubuntu-rootfs/sys
sudo mount -o bind /dev ubuntu-rootfs/dev
sudo mount -o bind /dev/pts ubuntu-rootfs/dev/pts
sudo tee ubuntu-rootfs/etc/apt/sources.list > /dev/null
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal main restricted universe multiverse
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-updates main restricted universe multiverse
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-security main restricted universe multiverse
deb http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ focal-backports main restricted universe multiverse
sudo chroot ubuntu-rootfs /bin/bash
# 在 chroot 环境中执行以下命令：

# 基础系统更新
apt update
apt upgrade -y

# 安装必要软件包
apt install -y systemd rsyslog sudo vim bash-completion \
               ssh net-tools ethtool ifupdown network-manager \
               iputils-ping wget curl htop

# 配置网络（根据需求选择 DHCP 或静态 IP）

# 选项 A: DHCP 配置
cat > /etc/network/interfaces.d/eth0 << 'EOF'
auto eth0
iface eth0 inet dhcp
pre-up ifconfig eth0 hw ether 10:10:10:10:10:10
EOF

# 选项 B: 静态 IP 配置（修改 IP 地址为实际值）
cat > /etc/network/interfaces.d/eth0 << 'EOF'
auto eth0
iface eth0 inet static
address 192.168.1.10
netmask 255.255.255.0
gateway 192.168.1.1
dns-nameservers 223.5.5.5 223.6.6.6
pre-up ifconfig eth0 hw ether 10:10:10:10:10:20
EOF

# 设置主机名
echo "hi3798mv100" > /etc/hostname
cat > /etc/hosts << EOF
127.0.0.1 localhost
127.0.0.1 hi3798mv100
EOF

# 配置系统服务
systemctl enable ssh
systemctl disable motd-news.timer
systemctl disable networkd-dispatcher

# 设置 root 密码
echo "请设置 root 密码："
passwd root

# 允许 root SSH 登录
echo "PermitRootLogin yes" >> /etc/ssh/sshd_config

# 创建 rc-local 服务
cat > /etc/systemd/system/rc-local.service << EOF
[Unit]
Description=/etc/rc.local Compatibility
ConditionPathExists=/etc/rc.local

[Service]
Type=forking
ExecStart=/etc/rc.local start
TimeoutSec=0
StandardOutput=tty
RemainAfterExit=yes
SysVStartPriority=99

[Install]
WantedBy=multi-user.target
EOF

# 创建 rc.local 脚本
cat > /etc/rc.local << 'EOF'
#!/bin/bash
# 开机后自动扩展分区（第一次启动时执行）
if [ -f /firstboot ]; then
    resize2fs /dev/mmcblk0p9
    rm -f /firstboot
fi
exit 0
EOF

chmod +x /etc/rc.local
systemctl enable rc-local

# 清理缓存
apt clean
rm -rf /var/lib/apt/lists/*

# 退出 chroot 环境
exit# 卸载挂载点
sudo umount ubuntu-rootfs/dev/pts
sudo umount ubuntu-rootfs/dev
sudo umount ubuntu-rootfs/sys
sudo umount ubuntu-rootfs/proc
# 挂载原始镜像
mkdir -p /mnt/rootfs
sudo mount /home/hongli/rootfs-32.img /mnt/rootfs

# 清空并复制新系统
sudo rm -rf /mnt/rootfs/*
sudo rsync -a ubuntu-rootfs/ /mnt/rootfs/

# 创建首次启动标记
sudo touch /mnt/rootfs/firstboot

# 卸载镜像
sudo umount /mnt/rootfs  
  # 压缩系统镜像（高压缩比）
gzip -9 -k -c rootfs-32.img > backup-32.gz
  # 在目标设备上执行：
# 挂载备份分区
mkdir -p /bak
mount /dev/mmcblk0p8 /bak

# 替换备份文件
cp backup-32.gz /bak/
sync

# 执行恢复命令（如果需要）
recoverbackup

# 首次启动后扩展分区
resize2fs /dev/mmcblk0p9
五、快速使用脚本
保存为 build_rootfs.sh
  #!/bin/bash
set -e

echo "=== Hi3798MV100 Ubuntu 根文件系统构建脚本 ==="

# 参数检查
if [ $# -lt 1 ]; then
    echo "用法: $0 <原始rootfs-32.img路径>"
    exit 1
fi

ORIG_IMG=$1
WORKDIR=$(pwd)

echo "[1/4] 准备环境..."
sudo apt update
sudo apt install -y qemu-user-static rsync

echo "[2/4] 构建根文件系统..."
# 此处添加上述构建步骤

echo "[3/4] 写入镜像..."
sudo mount ${ORIG_IMG} /mnt/rootfs
sudo rsync -a ubuntu-rootfs/ /mnt/rootfs/
sudo umount /mnt/rootfs

echo "[4/4] 完成！"
echo "生成的镜像: ${ORIG_IMG}"
echo "备份文件: ${WORKDIR}/backup-32.gz"
